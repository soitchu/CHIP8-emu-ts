<style>
  canvas {
    border: 1px solid black;
  }
</style>

<canvas width="64" height="32" id="display"> </canvas>

<script>
  const programs = {
    demos: [
      "Maze (alt) [David Winter, 199x].ch8",
      "Sierpinski [Sergey Naydenov, 2010].ch8",
      "Trip8 Demo (2008) [Revival Studios].ch8",
      "Maze [David Winter, 199x].ch8",
      "Sirpinski [Sergey Naydenov, 2010].ch8",
      "Zero Demo [zeroZshadow, 2007].ch8",
      "Particle Demo [zeroZshadow, 2008].ch8",
      "Stars [Sergey Naydenov, 2010].ch8",
    ],
    games: [
      "15 Puzzle [Roger Ivie] (alt).ch8",
      "15 Puzzle [Roger Ivie].ch8",
      "Addition Problems [Paul C. Moews].ch8",
      "Airplane.ch8",
      "Animal Race [Brian Astle].ch8",
      "Astro Dodge [Revival Studios, 2008].ch8",
      "Biorhythm [Jef Winsor].ch8",
      "Blinky [Hans Christian Egeberg, 1991].ch8",
      "Blinky [Hans Christian Egeberg] (alt).ch8",
      "Blitz [David Winter].ch8",
      "Bowling [Gooitzen van der Wal].ch8",
      "Breakout (Brix hack) [David Winter, 1997].ch8",
      "Breakout [Carmelo Cortez, 1979].ch8",
      "Brick (Brix hack, 1990).ch8",
      "Brix [Andreas Gustafsson, 1990].ch8",
      "Cave.ch8",
      "Coin Flipping [Carmelo Cortez, 1978].ch8",
      "Connect 4 [David Winter].ch8",
      "Craps [Camerlo Cortez, 1978].ch8",
      "Deflection [John Fort].ch8",
      "Figures.ch8",
      "Filter.ch8",
      "Guess [David Winter] (alt).ch8",
      "Guess [David Winter].ch8",
      "Hidden [David Winter, 1996].ch8",
      "Hi-Lo [Jef Winsor, 1978].ch8",
      "Kaleidoscope [Joseph Weisbecker, 1978].ch8",
      "Landing.ch8",
      "Lunar Lander (Udo Pernisz, 1979).ch8",
      "Mastermind FourRow (Robert Lindley, 1978).ch8",
      "Merlin [David Winter].ch8",
      "Missile [David Winter].ch8",
      "Most Dangerous Game [Peter Maruhnic].ch8",
      "Nim [Carmelo Cortez, 1978].ch8",
      "Paddles.ch8",
      "Pong (1 player).ch8",
      "Pong 2 (Pong hack) [David Winter, 1997].ch8",
      "Pong (alt).ch8",
      "Pong [Paul Vervalin, 1990].ch8",
      "Programmable Spacefighters [Jef Winsor].ch8",
      "Puzzle.ch8",
      "Reversi [Philip Baltzer].ch8",
      "Rocket [Joseph Weisbecker, 1978].ch8",
      "Rocket Launcher.ch8",
      "Rocket Launch [Jonas Lindstedt].ch8",
      "Rush Hour [Hap, 2006] (alt).ch8",
      "Rush Hour [Hap, 2006].ch8",
      "Russian Roulette [Carmelo Cortez, 1978].ch8",
      "Sequence Shoot [Joyce Weisbecker].ch8",
      "Shooting Stars [Philip Baltzer, 1978].ch8",
      "Slide [Joyce Weisbecker].ch8",
      "Soccer.ch8",
      "Space Flight.ch8",
      "Space Intercept [Joseph Weisbecker, 1978].ch8",
      "Space Invaders [David Winter] (alt).ch8",
      "Space Invaders [David Winter].ch8",
      "Spooky Spot [Joseph Weisbecker, 1978].ch8",
      "Squash [David Winter].ch8",
      "Submarine [Carmelo Cortez, 1978].ch8",
      "Sum Fun [Joyce Weisbecker].ch8",
      "Syzygy [Roy Trevino, 1990].ch8",
      "Tank.ch8",
      "Tapeworm [JDR, 1999].ch8",
      "Tetris [Fran Dachille, 1991].ch8",
      "Tic-Tac-Toe [David Winter].ch8",
      "Timebomb.ch8",
      "Tron.ch8",
      "UFO [Lutz V, 1992].ch8",
      "Vers [JMN, 1991].ch8",
      "Vertical Brix [Paul Robson, 1996].ch8",
      "Wall [David Winter].ch8",
      "Wipe Off [Joseph Weisbecker].ch8",
      "Worm V4 [RB-Revival Studios, 2007].ch8",
      "X-Mirror.ch8",
      "ZeroPong [zeroZshadow, 2007].ch8",
    ],
    programs: [
      "BMP Viewer - Hello (C8 example) [Hap, 2005].ch8",
      "Chip8 emulator Logo [Garstyciuks].ch8",
      "Chip8 Picture.ch8",
      "Clock Program [Bill Fisher, 1981].ch8",
      "Delay Timer Test [Matthew Mikolay, 2010].ch8",
      "Division Test [Sergey Naydenov, 2010].ch8",
      "Fishie [Hap, 2005].ch8",
      "Framed MK1 [GV Samways, 1980].ch8",
      "Framed MK2 [GV Samways, 1980].ch8",
      "IBM Logo.ch8",
      "Jumping X and O [Harry Kleinberg, 1977].ch8",
      "Keypad Test [Hap, 2006].ch8",
      "Life [GV Samways, 1980].ch8",
      "Minimal game [Revival Studios, 2007].ch8",
      "Random Number Test [Matthew Mikolay, 2010].ch8",
      "SQRT Test [Sergey Naydenov, 2010].ch8",
    ],
  };

  const display = document.getElementById("display");
  let scale = 20;
  const inputSharedBuffer = new SharedArrayBuffer(
    16 * Uint8Array.BYTES_PER_ELEMENT
  );
  const signalBuffer = new SharedArrayBuffer(1 * Uint8Array.BYTES_PER_ELEMENT);
  const signalArray = new Uint8Array(signalBuffer);
  const inputArray = new Uint8Array(inputSharedBuffer);
  const offscreen = display.transferControlToOffscreen();
  let worker = null;

  async function fetchProgram(url) {
    const response = await fetch(url);
    const buffer = await response.arrayBuffer();
    return new Uint8Array(buffer);
  }

  /**
   * Load a program by fetching it from the GitHub repository
   * @param {"demos" | "games" | "programs"} type
   * @param {string} name
   */
  async function loadProgram(type, name) {
    const programURL = encodeURI(
      `https://raw.githubusercontent.com/dmatlack/chip8/refs/heads/master/roms/${type}/${name}`
    );

    inputArray.fill(0);

    const program = await fetchProgram(programURL);

    // Initialize the worker with the offscreen canvas
    worker = new Worker("worker.js", {
      type: "module",
    });

    worker.postMessage(
      {
        action: "init",
        offscreenCanvas: offscreen,
        scale,
        program,
        disableGhosting: false,
        inputSharedBuffer,
        signalBuffer,
      },
      [offscreen]
    );
  }

  loadProgram("games", programs.games[12]);

  function changeScale(newScale) {
    // Pause the emulator so the message can be received by the worker
    signalArray[0] = 1;

    // Update the scale and send the new configuration to the worker
    scale = newScale;
    worker.postMessage({
      action: "config",
      config: {
        scale: newScale,
      },
    });

    // Resume the emulator after the configuration has been updated
    // Since the messages are queued, the configuration will be updated before 
    // the emulator is resumed
    resume();
  }

  function resume() {
    // Resume the emulator
    signalArray[0] = 0;

    // Send the resume signal to the worker
    worker.postMessage({
      action: "resume",
    });
  }

  const keyMap = {
    1: 0x1,
    2: 0x2,
    3: 0x3,
    4: 0xc,
    q: 0x4,
    w: 0x5,
    e: 0x6,
    r: 0xd,
    a: 0x7,
    s: 0x8,
    d: 0x9,
    f: 0xe,
    z: 0xa,
    x: 0x0,
    c: 0xb,
    v: 0xf,
  };

  // Send keyboard events to the worker
  window.addEventListener("keydown", (e) => {
    inputArray[keyMap[e.key]] = 1;
  });

  window.addEventListener("keyup", (e) => {
    inputArray[keyMap[e.key]] = 0;
  });
</script>

<script></script>
